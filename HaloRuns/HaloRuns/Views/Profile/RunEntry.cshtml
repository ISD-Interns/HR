@model HaloRuns.Models.ViewModels.RunForm


@section Title { Run Entry }

<strong>Create a Request for @Model.user.Username</strong>
<div class="RunFormcontainer" style="padding-top:50px">

    @using (Html.BeginForm("Create", "Runs", FormMethod.Post, new { @id = "CreateRequestPartialForm", @class = "form-horizontal", role = "form" }))
    {
        <h2>Create a Request</h2>
        <p>The select element is used to create a drop-down list.</p>

        <form id="Table" asp-controller="Profile" asp-action="RunPost">
            <label for="games">Choose a game:</label>
            <select id="games" class="games">

                <option value="-1">no selection</option>
                @foreach (var game in Model.games)
                {
                    <option value="@game.id"
                            data-edition-list-endpoint="@Url.RouteUrl("RunEntryFetchEditionRouteName", new { user = Model.user.Username, game = game.RouteName })"
                            data-map-list-endpoint="@Url.RouteUrl("RunEntryFetchMapRouteName", new { user = Model.user.Username, game = game.RouteName })">
                        @game.name
                    </option>
                }
            </select>
            <label for="edition">Choose an editon:</label>
            <select id="editions" class="editions">
                <option value="-1">no selection</option>
            </select>

            <label for="map">Choose a map:</label>
            <select id="maps" class="maps">
                <option value="-1"> no selction</option>
            </select>

            <label for="difficulties">Choose a difficulty:</label>
            <select id="difficulties" class="difficulties">
                <option value="-1"> no selction</option>
                @foreach (var diff in Model.difficulties)
                {
                    <option value="@diff.Id">
                        @diff.Name
                    </option>
                }
            </select>
            <button type="submit" form="nameform" value="Submit" id="Submit"
                    data-submit-endpoint="@Url.RouteUrl("RunSubmit", new {user = Model.user.Username})">
                Submit
            </button>
        </form>
        }
</div>


@section Scripts
{
    <script>
        $(document).ready(function () {

            $('#games').change(function () {
                /*
                function filter(myarray, pred)
                {
                    let ret = [];
                    for (let i = 0; i < myarray.length; ++i) {
                        if (pred(i) == true) {
                            ret.append(myarray[i]);
                        }
                    }
				}
                */
                $("#editions").children().filter(function (index) {
                    //return $(this).name != null;
                    return index != 0;
                }).remove();
                $("#maps").children().filter(function (index) {
                    //return $(this).name != null;
                    return index != 0;
                }).remove();

                /*
                $("#editions").children().filter(function (index) {
                    return index != 0;
                }.each(function (item) { item.empty(); });
                */

                const AbrevGameEdition = $(this).children('option:selected').first().data("edition-list-endpoint");
                $.get(AbrevGameEdition, null, function (response) {
                    console.log("hello");
                    response.forEach(function (item) {
                        const editionName = item.name;
                        const editionId = item.id;
                        $(".editions").append(`<option value=${editionId}> ${editionName}</option>`);
                    });
                });
                
                const AbrevGameMap = $(this).children('option:selected').first().data("map-list-endpoint");
                $.get(AbrevGameMap, null, function (response) {
                    console.log("hello");
                    response.forEach(function (item) {
                        const mapName = item.name;
                        const mapId = item.id;
                        console.log( mapId);
                        $(".maps").append(`<option value =${mapId}> ${mapName}</option>`);
                    });
                });

            });

            $('#Submit').click(function () {
                console.log("clicked");
                var mapId = $(".maps :selected").attr('value');
                var editionId = $(".editions :selected").attr('value');
                var difficultyId = $(".difficulties :selected").attr('value');
                var gameId = $(".games :selected").attr('value');
                const submitAbrev = $(this).data("submit-endpoint");
                var Ids = { map: mapId, edition: editionId, difficulty: difficultyId, game: gameId };
                var RunIds = JSON.stringify(Ids);
                var theId = "123";
                var theFilename = "somefile";
                var theDescription = "somedescription";
                var stringArray = new Array();
                stringArray[0] = mapId;
                stringArray[1] = editionId;
                stringArray[2] = difficultyId;
                stringArray[3] = gameId;
                var postData = { values: stringArray };
                $.ajax({
                    type: "POST",
                    url: submitAbrev,
                    data: postData,
                    success: function (data) {
                        alert(data.Result);
                    },
                    dataType: "json",
                    traditional: true
                });
                //$.post(submitAbrev, postData, function (response) {
                //    console.log(response);
                //});
            });
        });
    </script>
}
